<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>52 Card Pickup: Client Test</title>

  <link rel="icon" type="image/svg+xml" sizes="any" href="assets/icon.svg"/>
  <meta name="msapplication-TileColor" content="#ff0000">

  <link rel="stylesheet" href="./style.css">

  <script async src="./assets/config.js"></script>
  <script src="./assets/mnemonic.js" defer></script>
  <script type="module" src="./assets/client.js"></script>
  <script type="module">
    import getClient from './assets/client.js';

    const client = window.gClient = getClient(window.config);

    (async function() {
      await client.initialize();
      let remoteUser = await client.signIn();
      console.log("remoteUser:", remoteUser);

      let uid = remoteUser.uid;
      let displayName = mnemonic.encode([
        uid.charCodeAt(0),
        uid.charCodeAt(1),
        uid.charCodeAt(uid.length-1),
        uid.charCodeAt(Math.floor(Math.random() * uid.length))
      ],  "x x-x").replace(/\b([a-z])/g, (m, initialLetter) => initialLetter.toUpperCase());
      console.log("displayName:", displayName);

      const changeListener = {
        handleChange(label, data) {
          switch (label) {
            case "self-change":
              console.log("The user document got an update:", data);
              break;
            case "some-players":
              console.log("The some-players query got an update:", data);
              break;
            default: 
              console.info("changeListener got some change: ", label, data);
          }
        }
      }
      await client.addChangeListener({ collectionId: "players", docId: remoteUser.uid }, changeListener, "self-change");

      let somePlayersQuery = gClient.buildQuery({ collectionId: "players", whereTerms: ["uid", "!=", remoteUser.uid] });
      client.addChangeListener(somePlayersQuery, changeListener, "some-players");

      try {
        await client.updateDocument("players", remoteUser.uid, {
          displayName,
          lastSeen: Date.now()
        });
      } catch (ex) {
        console.warn("Failed to create/update user document: ", ex);
        return 
      }

      await new Promise(res => setTimeout(res, 5000));
      console.log("somePlayersQuery:", JSON.stringify(somePlayersQuery));
      client.removeChangeListener(somePlayersQuery, changeListener, "some-players");
    })();
  </script>
</head>

<body>
<div id="page-container">
</div>
</body>
</html>
